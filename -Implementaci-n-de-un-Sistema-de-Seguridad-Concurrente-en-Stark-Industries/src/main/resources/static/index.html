<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stark Security - Live</title>
  <link href="https://cdn.jsdelivr.net/npm/modern-normalize/modern-normalize.css" rel="stylesheet" />
  <style>
    :root { --bg:#0b1020; --card:#111931; --muted:#a8b3cf; --text:#e6edf7; --accent:#13b3ff; --warn:#ffbf47; --crit:#ff5c5c; }
    * { box-sizing: border-box; }
    body { font-family: "Zalando Sans Expanded", Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: var(--bg); color: var(--text); }
    h1, h2, h3, h4, h5, h6 { font-family: "Zalando Sans Expanded", Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    /* Background layer (non-intrusive, behind all content) */
    .bg { position: fixed; inset: 0; z-index: 0; overflow: hidden; pointer-events: none; }
    .bg-gradient { position: absolute; inset: -20%; background: radial-gradient(60% 60% at 10% 10%, rgba(19,179,255,.15) 0%, transparent 60%),
                                             radial-gradient(60% 60% at 90% 20%, rgba(255,92,92,.12) 0%, transparent 60%),
                                             radial-gradient(70% 70% at 50% 90%, rgba(255,191,71,.10) 0%, transparent 60%);
                      filter: blur(40px); transform: scale(1.1); animation: floatBg 18s ease-in-out infinite alternate; }
    .bg-blur { position: absolute; inset: 0; backdrop-filter: blur(6px) saturate(120%); background: linear-gradient(180deg, rgba(11,16,32,.35) 0%, rgba(11,16,32,.6) 100%); }
    @keyframes floatBg { from { transform: scale(1.05) translateY(-10px); } to { transform: scale(1.12) translateY(10px); } }
    /* Code typing/scrolling effect */
    .code-rain { position: absolute; inset: 0; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color: rgba(166, 190, 231, .14); 
                 line-height: 1.8; white-space: nowrap; display: flex; flex-direction: column; gap: 6px; padding: 60px 24px; mask-image: linear-gradient(180deg, transparent 0%, #000 10%, #000 90%, transparent 100%); }
    .code-rain span { display: inline-block; will-change: transform; filter: blur(.3px); }
    /* staggered columns that move like code being written/streamed */
    .code-rain span:nth-child(3n+1) { animation: scrollLine 18s linear infinite; }
    .code-rain span:nth-child(3n+2) { animation: scrollLine 22s linear infinite reverse; opacity: .85; }
    .code-rain span:nth-child(3n)   { animation: scrollLine 26s linear infinite; opacity: .7; }
    @keyframes scrollLine { 0% { transform: translateY(40px); } 100% { transform: translateY(-40px); } }
    header { padding: 20px 28px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #1d2542; background: rgba(14, 21, 48, .85); backdrop-filter: blur(6px) saturate(120%); position: sticky; top: 0; z-index: 2; }
    header h1 { margin: 0; font-size: 22px; letter-spacing: .2px; }
    main { padding: 24px; max-width: 1200px; margin: 0 auto; }
    nav { display: flex; gap: 8px; }
    .tab-btn { background: #0f1a36; color: var(--text); border: 1px solid #233056; padding: 8px 12px; border-radius: 8px; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; font-size: 14px; line-height: 1; }
    .tab-btn:hover { border-color: var(--accent); }
    .tab-btn.danger { color: #fff; border-color: #3a1b1b; background: #2a0f10; }
    .tab-btn.danger:hover { border-color: #ff5c5c; box-shadow: 0 0 0 3px rgba(255,92,92,.15); }
    .tab-btn.info { border-color: #1e3b52; background: #0f1e2a; }
    .tab-btn.info:hover { border-color: #13b3ff; box-shadow: 0 0 0 3px rgba(19,179,255,.15); }
    .tab-btn.warning { border-color: #4b3b1a; background: #21190a; }
    .tab-btn.warning:hover { border-color: #ffbf47; box-shadow: 0 0 0 3px rgba(255,191,71,.15); }
    .tab-btn.success { border-color: #1e3b2a; background: #0f1d14; }
    .tab-btn.success:hover { border-color: #28a745; box-shadow: 0 0 0 3px rgba(40,167,69,.15); }
    a { color: var(--accent); text-decoration: none; }
    footer { max-width: 1200px; margin: 24px auto; padding: 12px 24px; color: var(--muted); display: flex; justify-content: space-between; align-items: center; background: rgba(14, 21, 48, .95); border-top: 1px solid #1d2542; border-radius: 8px; position: relative; z-index: 2; backdrop-filter: none; }
    .footer-right a { color: var(--accent); }
    .card { background: rgba(17, 25, 49, .85); backdrop-filter: blur(8px) saturate(120%); border: 1px solid #1e2a4a; border-radius: 12px; padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.25); }
    .grid { display: grid; gap: 16px; }
    .grid-2 { grid-template-columns: 2fr 1fr; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #203059; }
    thead th { text-align: left; color: var(--muted); font-weight: 600; }
    tbody tr:hover { background: #0e1a38; }
    .badge { padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #2a3a65; }
    .CRITICAL { background: rgba(255,92,92,.15); border-color: #ff8a8a; color: #ffb3b3; }
    .WARN { background: rgba(255,191,71,.15); border-color: #ffd389; color: #ffe1a8; }
    .INFO { background: rgba(19,179,255,.15); border-color: #74d7ff; color: #b9ecff; }
    #status { margin-bottom: 10px; color: var(--muted); }
    .metrics pre { background: rgba(13,21,46,.8); backdrop-filter: blur(6px); border: 1px solid #24325a; border-radius: 8px; padding: 12px; color: #cbd6f6; max-height: 260px; overflow: auto; }
    .tab { display: none; }
    .tab.active { display: block; }
    .controls { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
    select, button { background: rgba(15,26,54,.9); color: var(--text); border: 1px solid #233056; padding: 8px 10px; border-radius: 8px; transition: transform .12s ease, box-shadow .12s ease, border-color .2s ease; }
    select:focus, button:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(19,179,255,.12); }
    .tab-btn:hover, button:hover { transform: translateY(-1px); }
    button { cursor: pointer; pointer-events: auto; }
    #btnLoadEvents, #btnLoadAccess { cursor: pointer; pointer-events: auto; z-index: 1; position: relative; }
    /* Login modal */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 5; }
    .overlay.show { display: flex; }
    .login-card { width: 360px; }
    .login-card h3 { margin-top: 0; }
    .login-card label { display: block; margin: 10px 0 4px; color: var(--muted); }
    .login-card input { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #233056; background: #0f1a36; color: var(--text); }
    .login-card .err { color: #ff8a8a; margin-top: 8px; display: none; }
    /* Estilos para el gráfico de rendimiento */
    #performanceChart { 
      background: rgba(15,26,54,.75); 
      border-radius: 8px; 
      padding: 10px;
      max-height: 300px;
    }
    
    /* Estilos para servicios de mensajería */
    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      min-width: 120px;
    }
    
    .status-label {
      font-weight: 500;
      color: var(--text);
    }
    
    .status-value {
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .status-value.available {
      background: #d4edda;
      color: #155724;
    }
    
    .status-value.unavailable {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status-value.checking {
      background: #fff3cd;
      color: #856404;
    }
    /* Scroll panel for warnings/alerts */
    .scroll-y { max-height: 320px; overflow: auto; border: 1px solid #203059; border-radius: 8px; }
    /* KPI tiles */
    .kpis { display: grid; grid-template-columns: repeat(4, minmax(160px, 1fr)); gap: 12px; }
    .kpi { background: rgba(17, 25, 49, .85); backdrop-filter: blur(8px) saturate(120%); border: 1px solid #1e2a4a; border-radius: 12px; padding: 14px; }
    .kpi .kpi-label { color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    .kpi .kpi-value { font-size: 22px; font-weight: 700; }
    .kpi .kpi-sub { color: var(--muted); font-size: 12px; margin-top: 4px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<!-- Non-intrusive animated background -->
<div class="bg" aria-hidden="true">
  <div class="bg-gradient"></div>
  <div class="bg-blur"></div>
  <div class="code-rain">
    <span>&lt;system&gt; Initializing security pipeline... ✓</span>
    <span>auth.role = ADMIN | SECURITY_ENGINEER | OPERATOR</span>
    <span>sensor.stream &gt;&gt; TEMPERATURE | MOTION | ACCESS</span>
    <span>AlertService.publish() :: ws://localhost:8080/ws</span>
    <span>metrics: sensor.events.processed.total ++</span>
    <span>latency.avg.ms = 12.4</span>
    <span>Messaging[EMAIL|SMS|PUSH] → status: AVAILABLE</span>
    <span>SecurityFilterChain ➜ authenticated routes: /, /index.html, /api/**</span>
    <span>Micrometer@MeterRegistry → /actuator/metrics</span>
    <span>Executor sensorExecutor{core=8, queue=LinkedBlockingQueue}</span>
  </div>
  <!-- A11y: hidden text ensures no interference with screen readers -->
  <div style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">Decorative animated background</div>
  </div>
<h1 style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">Stark Security</h1>

<header>
  <h1>Stark Security</h1>
  <nav>
    <button class="tab-btn" data-tab="tab-dashboard">Dashboard</button>
    <button class="tab-btn" data-tab="tab-events">Eventos</button>
    <button class="tab-btn" data-tab="tab-access">Accesos</button>
    <a class="tab-btn danger" href="/logout" style="margin-left:8px;">Cerrar Sesión</a>
  </nav>
  </header>
<main>

<section id="tab-dashboard" class="tab active">
  <div class="grid grid-2">
    <div class="card">
      <h2 style="margin-top:0">Live Alerts</h2>
      <div id="status">Conectando...</div>
      <div class="scroll-y">
        <table id="alerts">
          <thead><tr><th>Timestamp</th><th>Sensor</th><th>Tipo</th><th>Severidad</th><th>Mensaje</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="card metrics">
      <h3 style="margin-top:0">Métricas</h3>
      <pre id="metricsPre">Cargando métricas...</pre>
    </div>
  </div>
  <div class="kpis" style="margin-top:16px">
    <div class="kpi">
      <div class="kpi-label">Eventos procesados</div>
      <div class="kpi-value" id="kpiTotalEvents">0</div>
      <div class="kpi-sub">Total</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Eventos por segundo</div>
      <div class="kpi-value" id="kpiEps">0.0</div>
      <div class="kpi-sub">Últimos 2s</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Latencia promedio</div>
      <div class="kpi-value" id="kpiLatency">0 ms</div>
      <div class="kpi-sub">Procesamiento</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Accesos denegados</div>
      <div class="kpi-value" id="kpiAccessDenied">0</div>
      <div class="kpi-sub">Desde inicio</div>
    </div>
  </div>
    <div class="card" style="margin-top: 16px;">
      <h2 style="margin-top:0">Rendimiento del Sistema en Tiempo Real</h2>
      <div id="chartStatus" style="color: var(--muted); font-size: 14px; margin-bottom: 10px;">
        Esperando datos del sistema...
      </div>
      <canvas id="performanceChart" width="400" height="200"></canvas>
    </div>
    
    <div class="card" style="margin-top: 16px;">
      <h2 style="margin-top:0">Pruebas de Carga</h2>
      <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
        <label style="color: var(--muted);">Cantidad de eventos:</label>
        <input type="number" id="testEventCount" value="100" min="1" max="1000" 
               style="width: 80px; padding: 6px 8px; border-radius: 4px; border: 1px solid #233056; background: #0f1a36; color: var(--text);">
        <button onclick="generateTestEvents()" id="btnGenerateEvents" class="tab-btn success">Generar eventos</button>
        <button onclick="checkSensorCount()" class="tab-btn info">Ver sensores</button>
      </div>
      <div id="testResults" style="padding: 12px; background: rgba(13,21,46,.8); border-radius: 6px; font-family: monospace; font-size: 12px; color: #cbd6f6; min-height: 60px;">
        Haz clic en "Generar Eventos" para probar la capacidad de carga del sistema...
      </div>
  </div>
  
  
  
        <div class="card" style="margin-top: 16px;">
          <h2 style="margin-top:0">Servicios de Mensajería</h2>
    <div id="messagingStatus" style="margin-bottom: 16px;">
      <div style="display: flex; gap: 16px; flex-wrap: wrap;">
        <div class="status-item">
          <span class="status-label">Email:</span>
          <span id="emailStatus" class="status-value">Verificando...</span>
        </div>
      </div>
    </div>
    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">
      <button onclick="sendTestAlert('INFO')" class="tab-btn info">Probar INFO</button>
      <button onclick="sendTestAlert('WARN')" class="tab-btn warning">Probar WARN</button>
      <button onclick="sendTestAlert('CRITICAL')" class="tab-btn danger">Probar CRITICAL</button>
    </div>
    
    <div style="border-top: 1px solid var(--border); padding-top: 16px;">
      <h3 style="margin-top: 0; margin-bottom: 12px;">Enviar Alerta Personalizada</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
        <div>
          <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--muted);">Sensor</label>
          <input type="text" id="customSensor" placeholder="Nombre del sensor" style="width: 100%; padding: 6px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text);">
        </div>
        <div>
          <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--muted);">Severidad</label>
          <select id="customSeverity" style="width: 100%; padding: 6px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text);">
            <option value="INFO">INFO</option>
            <option value="WARN">WARN</option>
            <option value="CRITICAL">CRITICAL</option>
          </select>
        </div>
      </div>
      <div style="margin-bottom: 12px;">
        <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--muted);">Mensaje</label>
        <input type="text" id="customMessage" placeholder="Mensaje de la alerta" style="width: 100%; padding: 6px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text);">
      </div>
          <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--muted);">Emails (opcional - si no se especifica, usa configuración por defecto)</label>
            <input type="text" id="customEmails" placeholder="Dejar vacío para usar llansoanleo.mario@gmail.com" style="width: 100%; padding: 6px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text);">
          </div>
      <button onclick="sendCustomAlert()" class="btn" style="background: #28a745; width: 100%;">Enviar Alerta Personalizada</button>
    </div>
  </div>

  <!-- API compact card as the last item of dashboard -->
  <div class="card" style="margin-top: 12px; padding: 8px 12px;">
    <div style="display:flex; align-items:center; justify-content: space-between; gap: 12px;">
      <div style="display:flex; align-items:center; gap: 8px; color: var(--muted);">
        <strong style="font-size:14px; color: var(--text);">API</strong>
        <span>Documentación Swagger de la API REST.</span>
      </div>
      <a class="tab-btn info" href="/swagger-ui/index.html" target="_blank">Abrir Swagger</a>
    </div>
  </div>
</section>

<section id="tab-events" class="tab">
  <div class="card">
    <h2 style="margin-top:0">Eventos</h2>
    <div class="controls">
      <label>Tipo:</label>
      <select id="typeFilter"><option value="">Todos</option><option>MOTION</option><option>TEMPERATURE</option><option>ACCESS</option></select>
      <label>Severidad:</label>
      <select id="sevFilter"><option value="">Todas</option><option>INFO</option><option>WARN</option><option>CRITICAL</option></select>
      <button id="btnLoadEvents">Cargar</button>
    </div>
    <div class="card" style="margin-bottom:12px; background:#0e1530">
      <div class="controls" style="flex-wrap:wrap">
        <strong style="margin-right:8px">Agregar evento</strong>
        <label>Sensor</label>
        <select id="sensorSelect" style="min-width:220px"></select>
        <label>Tipo</label>
        <select id="eventType">
          <option>MOTION</option>
          <option>TEMPERATURE</option>
          <option>ACCESS</option>
        </select>
        <label>Valor</label>
        <input id="eventValue" placeholder="p.ej. MOTION_DETECTED / 42 / true" value="test" style="width:240px; background:#0f1a36; color:#e6edf7; border:1px solid #233056; padding:8px 10px; border-radius:8px" />
        <label>Severidad</label>
        <select id="eventSeverity" style="min-width:120px">
          <option value="INFO">INFO</option>
          <option value="WARN">WARN</option>
          <option value="CRITICAL">CRITICAL</option>
        </select>
        <button id="btnAddEvent">Enviar</button>
      </div>
    </div>
    <table id="eventsTable">
      <thead><tr><th>Ts</th><th>SensorId</th><th>Tipo</th><th>Severidad</th><th>Valor</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<section id="tab-access" class="tab">
  <div class="card">
    <h2 style="margin-top:0">Accesos</h2>
    <div class="card" style="margin-bottom:12px; background:#0e1530">
      <div class="controls" style="flex-wrap:wrap">
        <strong style="margin-right:8px">Agregar acceso</strong>
        <label>Persona</label>
        <input id="accessPerson" placeholder="Nombre de la persona" style="width:200px; background:#0f1a36; color:#e6edf7; border:1px solid #233056; padding:8px 10px; border-radius:8px" />
        <label>Ubicación</label>
        <input id="accessLocation" placeholder="Ubicación" style="width:200px; background:#0f1a36; color:#e6edf7; border:1px solid #233056; padding:8px 10px; border-radius:8px" />
        <label>Autorizado</label>
        <select id="accessAuthorized" style="min-width:120px; background:#0f1a36; color:#e6edf7; border:1px solid #233056; padding:8px 10px; border-radius:8px">
          <option value="true">Sí</option>
          <option value="false">No</option>
        </select>
        <button id="btnAddAccess">Enviar</button>
      </div>
    </div>
    <table id="accessTable">
      <thead><tr><th>Ts</th><th>Persona</th><th>Autorizado</th><th>Ubicación</th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:10px"><button id="btnLoadAccess">Cargar accesos</button></div>
  </div>
</section>

<script>
  let client;
  function connect() {
    console.log('Intentando conectar WebSocket...');
    const socket = new SockJS('/ws');
    client = Stomp.over(socket);
    client.debug = function(str) {
      console.log('STOMP: ' + str);
    };
    client.connect({}, function() {
      console.log('WebSocket conectado exitosamente');
      document.getElementById('status').innerText = 'Conectado a /topic/alerts';
      client.subscribe('/topic/alerts', function(message) {
        console.log('Alerta recibida:', message.body);
        const m = JSON.parse(message.body);
        addRow(m);
      });
    }, function(error) {
      console.error('Error conectando WebSocket:', error);
      document.getElementById('status').innerText = 'Error de conexión - Reconectando...';
      setTimeout(connect, 2000);
    });
  }
  function addRow(m) {
    const tr = document.createElement('tr');
    tr.className = m.severity;
    tr.innerHTML = `<td>${new Date(m.timestamp).toLocaleTimeString()}</td><td>${m.sensorName}</td><td>${m.type}</td><td>${m.severity}</td><td>${m.message}</td>`;
    document.querySelector('#alerts tbody').prepend(tr);
  }
  async function loadMetrics() {
    try {
      const res = await fetch('/api/metrics/public');
      const data = await res.json();
      document.getElementById('metricsPre').innerText = JSON.stringify(data, null, 2);
    } catch (e) { document.getElementById('metricsPre').innerText = 'Error cargando métricas'; }
    setTimeout(loadMetrics, 5000);
  }
  async function loadEvents() {
    try {
      const type = document.getElementById('typeFilter').value;
      const sev = document.getElementById('sevFilter').value;
      const p = new URLSearchParams();
      if (type) p.append('type', type);
      if (sev) p.append('severity', sev);
      p.append('page','0'); p.append('size','20');
      const res = await fetch('/api/events?' + p.toString(), { redirect: 'manual', credentials: 'same-origin' });
      if (res.status === 401 || res.status === 403 || res.status === 302) { return showLogin(loadEvents); }
      if (!res.ok) { 
        const errorText = await res.text();
        showErrorMessage('Error cargando eventos (HTTP '+res.status+'): ' + errorText); 
        return; 
      }
      const data = await res.json();
      console.log('Events data:', data);
      const tbody = document.querySelector('#eventsTable tbody');
      tbody.innerHTML = '';
      const events = data.content || [];
      events.forEach(e => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(e.ts).toLocaleString()}</td><td>${e.sensorId}</td><td>${e.type}</td><td>${e.severity}</td><td>${e.value ?? ''}</td>`;
        tbody.appendChild(tr);
      });
    } catch (error) {
      console.error('Error loading events:', error);
      showErrorMessage('Error cargando eventos: ' + error.message);
    }
  }
  async function loadAccess() {
    try {
      const res = await fetch('/api/access/logs', { redirect: 'manual', credentials: 'same-origin' });
      if (res.status === 401 || res.status === 302) { return showLogin(loadAccess); }
      if (res.status === 403) {
        const errorData = await res.json().catch(() => ({}));
        showErrorMessage(errorData.message || 'No autorizado para ver accesos');
        return;
      }
      if (!res.ok) { 
        const errorText = await res.text();
        showErrorMessage('Error cargando accesos (HTTP '+res.status+'): ' + errorText); 
        return; 
      }
      const data = await res.json();
      console.log('Access data:', data);
      const tbody = document.querySelector('#accessTable tbody');
      tbody.innerHTML = '';
      data.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(a.ts).toLocaleString()}</td><td>${a.personName} (${a.personId})</td><td>${a.authorized}</td><td>${a.location}</td>`;
        tbody.appendChild(tr);
      });
    } catch (error) {
      console.error('Error loading access:', error);
      showErrorMessage('Error cargando accesos: ' + error.message);
    }
  }

  // Tabs
  function activateTab(id) {
    document.querySelectorAll('.tab').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => activateTab(btn.dataset.tab));
  });

  // Gráfico de rendimiento en tiempo real
  let performanceChart;
  let performanceData = {
    labels: [],
    datasets: [{
      label: 'Eventos/seg',
      data: [],
      borderColor: '#13b3ff',
      backgroundColor: 'rgba(19, 179, 255, 0.1)',
      tension: 0.4
    }, {
      label: 'Latencia (ms)',
      data: [],
      borderColor: '#ffbf47',
      backgroundColor: 'rgba(255, 191, 71, 0.1)',
      tension: 0.4,
      yAxisID: 'y1'
    }]
  };

  function initPerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    // Configurar Chart.js para tema oscuro
    Chart.defaults.color = '#e6edf7';
    Chart.defaults.borderColor = '#233056';
    Chart.defaults.backgroundColor = 'rgba(19, 179, 255, 0.1)';
    
    performanceChart = new Chart(ctx, {
      type: 'line',
      data: performanceData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        scales: {
          x: {
            ticks: {
              color: '#a8b3cf',
              maxTicksLimit: 10
            },
            grid: {
              color: '#233056'
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'Eventos/seg',
              color: '#e6edf7'
            },
            ticks: {
              color: '#a8b3cf'
            },
            grid: {
              color: '#233056'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'Latencia (ms)',
              color: '#e6edf7'
            },
            ticks: {
              color: '#a8b3cf'
            },
            grid: {
              drawOnChartArea: false,
            },
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: '#e6edf7'
            }
          },
          tooltip: {
            backgroundColor: '#111931',
            titleColor: '#e6edf7',
            bodyColor: '#a8b3cf',
            borderColor: '#233056',
            borderWidth: 1
          }
        }
      }
    });
  }

  async function updatePerformanceChart() {
    try {
      // Obtener métricas específicas de sensores
      const res = await fetch('/api/sensors/metrics');
      if (res.ok) {
        const metrics = await res.json();
        console.log('Métricas obtenidas:', metrics);
        
        // Extraer métricas relevantes
        const eventsProcessed = metrics.sensor_events_processed_total || 0;
        const latency = metrics.sensor_events_latency_ms || 0;
        
        // Actualizar KPIs de sensores
        updateKpisFromSensorMetrics(eventsProcessed, latency);

        // Solo agregar datos si hay métricas reales
        if (eventsProcessed > 0 || latency > 0) {
          const now = new Date();
          const time = now.toLocaleTimeString();
          
          // Agregar nuevos datos
          performanceData.labels.push(time);
          performanceData.datasets[0].data.push(eventsProcessed);
          performanceData.datasets[1].data.push(latency);
          
          // Mantener solo los últimos 20 puntos
          if (performanceData.labels.length > 20) {
            performanceData.labels.shift();
            performanceData.datasets[0].data.shift();
            performanceData.datasets[1].data.shift();
          }
          
          // Actualizar gráfico
          if (performanceChart) {
            performanceChart.update('none');
          }
          
          // Actualizar estado
          document.getElementById('chartStatus').textContent = 
            `Datos en tiempo real - Eventos procesados: ${eventsProcessed}, Latencia promedio: ${latency.toFixed(1)}ms`;
        } else {
          // No hay datos reales disponibles
          document.getElementById('chartStatus').textContent = 
            'Esperando actividad del sistema... (Procesa algunos eventos para ver datos)';
        }
      }
    } catch (error) {
      console.log('Error obteniendo métricas para gráfico:', error);
      document.getElementById('chartStatus').textContent = 
        'Error obteniendo métricas del sistema';
    }
  }

  // Estado previo para calcular EPS
  let prevEventsProcessed = null;
  let prevEpsTs = null;

  function updateKpisFromSensorMetrics(eventsProcessed, latencyMs) {
    // Total
    const elTotal = document.getElementById('kpiTotalEvents');
    if (elTotal) elTotal.textContent = Number(eventsProcessed).toLocaleString();

    // EPS calculado por delta/tiempo
    const now = Date.now();
    let eps = 0;
    if (prevEventsProcessed !== null && prevEpsTs !== null && eventsProcessed >= prevEventsProcessed) {
      const deltaCount = eventsProcessed - prevEventsProcessed;
      const deltaSec = Math.max(0.001, (now - prevEpsTs) / 1000);
      eps = deltaCount / deltaSec;
    }
    prevEventsProcessed = eventsProcessed;
    prevEpsTs = now;
    const elEps = document.getElementById('kpiEps');
    if (elEps) elEps.textContent = eps.toFixed(2);

    // Latencia
    const elLat = document.getElementById('kpiLatency');
    if (elLat) elLat.textContent = `${Number(latencyMs).toFixed(1)} ms`;
  }

  async function updateAccessDeniedKpi() {
    try {
      const res = await fetch('/actuator/metrics/access.denied', { credentials: 'same-origin', redirect: 'manual' });
      if (!res.ok) return;
      const data = await res.json();
      // Buscar primer valor de medición
      const value = (data.measurements && data.measurements.length > 0) ? (data.measurements[0].value || 0) : 0;
      const el = document.getElementById('kpiAccessDenied');
      if (el) el.textContent = Number(value).toLocaleString();
    } catch {}
  }

  // Funciones para servicios de mensajería
  async function loadMessagingStatus() {
    try {
      const res = await fetch('/api/messaging/status');
      if (res.ok) {
        const status = await res.json();
        updateMessagingStatus(status);
      }
    } catch (error) {
      console.log('Error loading messaging status:', error);
    }
  }

  function updateMessagingStatus(status) {
    const emailStatus = document.getElementById('emailStatus');

    if (emailStatus) {
      emailStatus.textContent = status.EMAIL ? 'Disponible' : 'No disponible';
      emailStatus.className = 'status-value ' + (status.EMAIL ? 'available' : 'unavailable');
    }
  }

  async function sendTestAlert(severity) {
    try {
      const res = await fetch('/api/messaging/test?severity=' + severity, {
        method: 'POST'
      });
      
      if (res.ok) {
        const result = await res.json();
        console.log('Alerta de prueba enviada:', result);
        alert('Alerta de prueba ' + severity + ' enviada correctamente');
      } else {
        alert('Error enviando alerta de prueba');
      }
    } catch (error) {
      console.log('Error sending test alert:', error);
      alert('Error enviando alerta de prueba');
    }
  }

  async function sendCustomAlert() {
    try {
      // Obtener valores del formulario
      const sensorName = document.getElementById('customSensor').value || 'Sensor Personalizado';
      const severity = document.getElementById('customSeverity').value;
      const message = document.getElementById('customMessage').value || 'Alerta personalizada del sistema';
      
      // Procesar emails
      const emailsStr = document.getElementById('customEmails').value;
      const emailRecipients = emailsStr ? emailsStr.split(',').map(e => e.trim()).filter(e => e) : [];
      
      // Si no se especifican emails, se usará la configuración por defecto
      
      // Crear el objeto de solicitud
      const alertRequest = {
        sensorName: sensorName,
        sensorType: 'TEMPERATURE', // Tipo por defecto
        severity: severity,
        message: message,
        emailRecipients: emailRecipients
      };
      
      console.log('Enviando alerta personalizada:', alertRequest);
      
      const res = await fetch('/api/messaging/send-custom', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(alertRequest)
      });
      
      if (res.ok) {
        const result = await res.json();
        console.log('Alerta personalizada enviada:', result);
        
        // Mostrar resumen de envío
        let summary = `Alerta ${severity} enviada a:\n`;
        if (emailRecipients.length > 0) {
          summary += `${emailRecipients.length} emails personalizados\n`;
        } else {
          summary += `Email por defecto (llansoanleo.mario@gmail.com)\n`;
        }
        
        alert(summary);
        
        // Limpiar formulario
        document.getElementById('customSensor').value = '';
        document.getElementById('customMessage').value = '';
        document.getElementById('customEmails').value = '';
        
      } else {
        const error = await res.json();
        alert('Error enviando alerta personalizada: ' + (error.message || 'Error desconocido'));
      }
    } catch (error) {
      console.log('Error sending custom alert:', error);
      alert('Error enviando alerta personalizada');
    }
  }


  // Init
  connect();
  loadMetrics();
  initPerformanceChart();
  loadMessagingStatus();
  updateAccessDeniedKpi();
  
  // Actualizar gráfico cada 2 segundos
  setInterval(updatePerformanceChart, 2000);
  // Actualizar KPI de accesos denegados cada 5 segundos
  setInterval(updateAccessDeniedKpi, 5000);
  
  // Test simple para verificar que JavaScript funciona
  console.log('JavaScript is working!');
  
  // Debug: Verificar que los elementos existen
  console.log('btnLoadEvents element:', document.getElementById('btnLoadEvents'));
  console.log('btnLoadAccess element:', document.getElementById('btnLoadAccess'));
  
  // Test de función
  window.testLoadEvents = function() {
    console.log('testLoadEvents called');
    loadEvents();
  };
  
  // Event listeners con debugging
  const btnLoadEvents = document.getElementById('btnLoadEvents');
  const btnLoadAccess = document.getElementById('btnLoadAccess');
  
  if (btnLoadEvents) {
    btnLoadEvents.addEventListener('click', function() {
      console.log('btnLoadEvents clicked');
      loadEvents();
    });
  } else {
    console.error('btnLoadEvents not found!');
  }
  
  if (btnLoadAccess) {
    btnLoadAccess.addEventListener('click', function() {
      console.log('btnLoadAccess clicked');
      loadAccess();
    });
  } else {
    console.error('btnLoadAccess not found!');
  }
  // Cargar sensores para el combo de "Agregar evento"
  async function loadSensors() {
    try {
      const res = await fetch('/api/sensors/public', { credentials: 'same-origin', redirect: 'manual' });
      if (res.status === 401 || res.status === 302) return; // se pedirá login al intentar enviar
      const sensors = await res.json();
      const sel = document.getElementById('sensorSelect');
      sel.innerHTML = '';
      sensors.forEach(s => {
        const o = document.createElement('option'); o.value = s.id; o.textContent = `${s.name} (${s.type})`;
        sel.appendChild(o);
      });
    } catch (e) {
      console.error('Error loading sensors:', e);
    }
  }
  loadSensors();

  async function addEvent() {
    const sensorId = document.getElementById('sensorSelect').value;
    const type = document.getElementById('eventType').value;
    const value = document.getElementById('eventValue').value || '';
    const severity = document.getElementById('eventSeverity').value;
    if (!sensorId) { alert('Selecciona un sensor'); return; }
    const body = JSON.stringify({ sensorId, type, value, severity });
    const res = await fetch(`/api/sensors/${sensorId}/events`, { method: 'POST', headers: { 'Content-Type':'application/json' }, body, credentials: 'same-origin', redirect: 'manual' });
    if (res.status === 401 || res.status === 302) { return showLogin(addEvent); }
    if (res.status === 403) { 
      const errorData = await res.json().catch(() => ({}));
      showErrorMessage(errorData.message || 'No autorizado para enviar eventos'); 
      return; 
    }
    if (res.ok || res.status === 202) {
      document.getElementById('eventValue').value = '';
      // refrescar tabla de eventos
      setTimeout(loadEvents, 300);
    } else {
      const errorData = await res.json().catch(() => ({}));
      showErrorMessage(errorData.message || 'Error enviando evento (HTTP '+res.status+')');
    }
  }
  document.getElementById('btnAddEvent').addEventListener('click', addEvent);

  // Función para agregar acceso
  async function addAccess() {
    const person = document.getElementById('accessPerson').value;
    const location = document.getElementById('accessLocation').value;
    const authorized = document.getElementById('accessAuthorized').value === 'true';
    
    if (!person || !location) { 
      alert('Completa todos los campos'); 
      return; 
    }
    
    const body = JSON.stringify({ 
      personId: person,
      personName: person,
      location, 
      authorized 
    });
    
    const res = await fetch('/api/access/logs', { 
      method: 'POST', 
      headers: { 'Content-Type':'application/json' }, 
      body, 
      credentials: 'same-origin', 
      redirect: 'manual' 
    });
    
    if (res.status === 401 || res.status === 302) { 
      return showLogin(addAccess); 
    }
    if (res.status === 403) { 
      const errorData = await res.json().catch(() => ({}));
      showErrorMessage(errorData.message || 'No autorizado para crear accesos'); 
      return; 
    }
    if (res.ok || res.status === 201) {
      // Limpiar formulario
      document.getElementById('accessPerson').value = '';
      document.getElementById('accessLocation').value = '';
      document.getElementById('accessAuthorized').value = 'true';
      // Refrescar tabla de accesos
      setTimeout(loadAccess, 300);
    } else {
      const errorData = await res.json().catch(() => ({}));
      showErrorMessage(errorData.message || 'Error creando acceso (HTTP '+res.status+')');
    }
  }
  document.getElementById('btnAddAccess').addEventListener('click', addAccess);

  // Login modal logic
  let pendingAction = null;
  function showLogin(next) {
    pendingAction = next;
    document.getElementById('loginOverlay').classList.add('show');
  }

  // Función para mostrar mensajes de error profesionales
  function showErrorMessage(message, type = 'error') {
    // Crear elemento de notificación
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#17a2b8'};
      color: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10000;
      max-width: 400px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
      line-height: 1.4;
      border-left: 4px solid ${type === 'error' ? '#c82333' : type === 'success' ? '#1e7e34' : '#138496'};
    `;
    
    // Agregar icono según el tipo
    const icon = type === 'error' ? '⚠️' : type === 'success' ? '✅' : 'ℹ️';
    notification.innerHTML = `
      <div style="display: flex; align-items: flex-start; gap: 12px;">
        <span style="font-size: 18px; flex-shrink: 0;">${icon}</span>
        <div style="flex: 1;">
          <div style="font-weight: 600; margin-bottom: 4px;">
            ${type === 'error' ? 'Error del Sistema' : type === 'success' ? 'Operación Exitosa' : 'Información'}
          </div>
          <div>${message}</div>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" 
                style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; padding: 0; margin-left: 8px;">
          ×
        </button>
      </div>
    `;
    
    // Agregar al DOM
    document.body.appendChild(notification);
    
    // Auto-remover después de 8 segundos
    setTimeout(() => {
      if (notification.parentElement) {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        notification.style.transition = 'all 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }
    }, 8000);
  }

  // Función para mostrar mensajes de éxito
  function showSuccessMessage(message) {
    showErrorMessage(message, 'success');
  }

  // Función para mostrar mensajes informativos
  function showInfoMessage(message) {
    showErrorMessage(message, 'info');
  }

  // Funciones para pruebas de carga
  async function generateTestEvents() {
    const count = parseInt(document.getElementById('testEventCount').value) || 100;
    const btn = document.getElementById('btnGenerateEvents');
    const results = document.getElementById('testResults');
    
    // Deshabilitar botón durante la prueba
    btn.disabled = true;
    btn.textContent = '⏳ Generando...';
    results.innerHTML = '🚀 Iniciando generación de ' + count + ' eventos...\n⏳ Procesando...';
    
    try {
      const startTime = Date.now();
      const response = await fetch(`/api/test/generate-events?count=${count}`, {
        method: 'POST',
        credentials: 'same-origin',
        redirect: 'manual'
      });
      
      if (response.status === 401 || response.status === 302) {
        return showLogin(() => generateTestEvents());
      }
      
      if (response.status === 403) {
        const errorData = await response.json().catch(() => ({}));
        showErrorMessage(errorData.message || 'No autorizado para generar eventos de prueba');
        return;
      }
      
      const data = await response.json();
      const endTime = Date.now();
      const totalTime = endTime - startTime;
      
      if (data.success) {
        results.innerHTML = `
✅ <strong>Prueba completada exitosamente!</strong>
📊 <strong>Estadísticas:</strong>
   • Eventos solicitados: ${data.totalRequested}
   • Eventos exitosos: ${data.successful}
   • Errores: ${data.errors}
   • Tiempo total: ${totalTime}ms
   • Tiempo del servidor: ${data.durationMs}ms
   • Eventos por segundo: ${data.eventsPerSecond}
   • Eficiencia: ${((data.successful / data.totalRequested) * 100).toFixed(1)}%

🎯 <strong>Análisis de rendimiento:</strong>
   • ${data.successful >= data.totalRequested * 0.95 ? '✅ Excelente' : data.successful >= data.totalRequested * 0.8 ? '⚠️ Bueno' : '❌ Necesita optimización'} - Procesamiento de eventos
   • ${parseFloat(data.eventsPerSecond) > 50 ? '✅ Excelente' : parseFloat(data.eventsPerSecond) > 20 ? '⚠️ Bueno' : '❌ Lento'} - Velocidad de procesamiento
   • ${data.errors === 0 ? '✅ Perfecto' : data.errors <= data.totalRequested * 0.05 ? '⚠️ Aceptable' : '❌ Muchos errores'} - Tasa de errores
        `;
        
        showSuccessMessage(`Prueba completada: ${data.successful}/${data.totalRequested} eventos procesados en ${data.eventsPerSecond} eventos/segundo`);
        
        // Refrescar datos después de la prueba
        setTimeout(() => {
          loadEvents();
          updatePerformanceChart();
        }, 1000);
        
      } else {
        results.innerHTML = `❌ <strong>Error en la prueba:</strong>\n${data.message}`;
        showErrorMessage('Error en la prueba de carga: ' + data.message);
      }
      
    } catch (error) {
      console.error('Error en prueba de carga:', error);
      results.innerHTML = `❌ <strong>Error de conexión:</strong>\n${error.message}`;
      showErrorMessage('Error de conexión durante la prueba: ' + error.message);
    } finally {
      // Rehabilitar botón
      btn.disabled = false;
      btn.textContent = '🚀 Generar Eventos';
    }
  }

  async function checkSensorCount() {
    const results = document.getElementById('testResults');
    results.innerHTML = '📊 Consultando sensores disponibles...';
    
    try {
      const response = await fetch('/api/test/sensors/count', {
        credentials: 'same-origin',
        redirect: 'manual'
      });
      
      if (response.status === 401 || response.status === 302) {
        return showLogin(() => checkSensorCount());
      }
      
      if (response.status === 403) {
        const errorData = await response.json().catch(() => ({}));
        showErrorMessage(errorData.message || 'No autorizado para consultar sensores');
        return;
      }
      
      const data = await response.json();
      results.innerHTML = `📊 <strong>Información del sistema:</strong>\n${data.message}\n\n💡 <strong>Nota:</strong> Se necesitan sensores para generar eventos de prueba.`;
      
    } catch (error) {
      console.error('Error consultando sensores:', error);
      results.innerHTML = `❌ <strong>Error consultando sensores:</strong>\n${error.message}`;
    }
  }
  async function doLogin(ev) {
    ev.preventDefault();
    const form = ev.target;
    const u = form.username.value; const p = form.password.value;
    const body = new URLSearchParams({ username: u, password: p }).toString();
    const res = await fetch('/login', { method: 'POST', headers: {'Content-Type':'application/x-www-form-urlencoded'}, body, redirect: 'manual', credentials: 'same-origin' });
    if (res.ok || res.status === 302) {
      document.getElementById('loginErr').style.display = 'none';
      document.getElementById('loginOverlay').classList.remove('show');
      // Verificar que la sesión está activa antes de reintentar
      try {
        const probe = await fetch('/api/sensors', { credentials: 'same-origin', redirect: 'manual' });
        if (probe.status === 401 || probe.status === 403) {
          document.getElementById('loginErr').style.display = 'block';
          return;
        }
      } catch {}
      const next = pendingAction; pendingAction = null; if (next) next();
    } else {
      document.getElementById('loginErr').style.display = 'block';
    }
  }
  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('loginForm').addEventListener('submit', doLogin);
    document.getElementById('loginCancel').addEventListener('click', () => {
      pendingAction = null; document.getElementById('loginOverlay').classList.remove('show');
    });
    
    // Re-attach event listeners after DOM is loaded
    const btnLoadEvents = document.getElementById('btnLoadEvents');
    const btnLoadAccess = document.getElementById('btnLoadAccess');
    
    if (btnLoadEvents) {
      btnLoadEvents.addEventListener('click', function() {
        console.log('btnLoadEvents clicked (DOMContentLoaded)');
        loadEvents();
      });
    }
    
    if (btnLoadAccess) {
      btnLoadAccess.addEventListener('click', function() {
        console.log('btnLoadAccess clicked (DOMContentLoaded)');
        loadAccess();
      });
    }
  });
</script>

<!-- Login Overlay -->
<div class="overlay" id="loginOverlay">
  <form class="card login-card" id="loginForm">
    <h3>Autenticación requerida</h3>
    <label>Usuario</label>
    <input type="text" name="username" required autocomplete="username" />
    <label>Contraseña</label>
    <input type="password" name="password" required autocomplete="current-password" />
    <div style="display:flex; gap:8px; margin-top:12px">
      <button type="submit" style="flex:1">Entrar</button>
      <button type="button" id="loginCancel" style="flex:1">Cancelar</button>
    </div>
    <div class="err" id="loginErr">Credenciales inválidas</div>
    <p style="color:#a8b3cf; margin-top:10px">Demo: admin/admin, sec/sec, op/op</p>
  </form>
</div>
 </main>
 </body>
 </html>



