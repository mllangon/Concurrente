<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stark Security - Live</title>
  <link href="https://cdn.jsdelivr.net/npm/modern-normalize/modern-normalize.css" rel="stylesheet" />
  <style>
    :root { --bg:#0b1020; --card:#111931; --muted:#a8b3cf; --text:#e6edf7; --accent:#13b3ff; --warn:#ffbf47; --crit:#ff5c5c; }
    * { box-sizing: border-box; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: var(--bg); color: var(--text); }
    header { padding: 20px 28px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #1d2542; background: #0e1530; position: sticky; top: 0; z-index: 2; }
    header h1 { margin: 0; font-size: 22px; letter-spacing: .2px; }
    main { padding: 24px; max-width: 1200px; margin: 0 auto; }
    nav { display: flex; gap: 8px; }
    .tab-btn { background: #0f1a36; color: var(--text); border: 1px solid #233056; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
    .tab-btn:hover { border-color: var(--accent); }
    a { color: var(--accent); text-decoration: none; }
    .card { background: var(--card); border: 1px solid #1e2a4a; border-radius: 12px; padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.25); }
    .grid { display: grid; gap: 16px; }
    .grid-2 { grid-template-columns: 2fr 1fr; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #203059; }
    thead th { text-align: left; color: var(--muted); font-weight: 600; }
    tbody tr:hover { background: #0e1a38; }
    .badge { padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #2a3a65; }
    .CRITICAL { background: rgba(255,92,92,.15); border-color: #ff8a8a; color: #ffb3b3; }
    .WARN { background: rgba(255,191,71,.15); border-color: #ffd389; color: #ffe1a8; }
    .INFO { background: rgba(19,179,255,.15); border-color: #74d7ff; color: #b9ecff; }
    #status { margin-bottom: 10px; color: var(--muted); }
    .metrics pre { background: #0d152e; border: 1px solid #24325a; border-radius: 8px; padding: 12px; color: #cbd6f6; max-height: 260px; overflow: auto; }
    .tab { display: none; }
    .tab.active { display: block; }
    .controls { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
    select, button { background: #0f1a36; color: var(--text); border: 1px solid #233056; padding: 8px 10px; border-radius: 8px; }
    button { cursor: pointer; pointer-events: auto; }
    #btnLoadEvents, #btnLoadAccess { cursor: pointer; pointer-events: auto; z-index: 1; position: relative; }
    /* Login modal */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 5; }
    .overlay.show { display: flex; }
    .login-card { width: 360px; }
    .login-card h3 { margin-top: 0; }
    .login-card label { display: block; margin: 10px 0 4px; color: var(--muted); }
    .login-card input { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #233056; background: #0f1a36; color: var(--text); }
    .login-card .err { color: #ff8a8a; margin-top: 8px; display: none; }
    /* Estilos para el gráfico de rendimiento */
    #performanceChart { 
      background: #0f1a36; 
      border-radius: 8px; 
      padding: 10px;
      max-height: 300px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
<body>
<h1>Stark Security</h1>

<header>
  <h1>Stark Security</h1>
  <nav>
    <button class="tab-btn" data-tab="tab-dashboard">Dashboard</button>
    <button class="tab-btn" data-tab="tab-events">Eventos</button>
    <button class="tab-btn" data-tab="tab-access">Accesos</button>
    <a href="/swagger-ui/index.html" target="_blank" style="margin-left:8px">Swagger</a>
    <a href="/logout" style="margin-left:8px; color: var(--crit);">Cerrar Sesión</a>
  </nav>
  </header>
<main>

<section id="tab-dashboard" class="tab active">
  <div class="grid grid-2">
    <div class="card">
      <h2 style="margin-top:0">Live Alerts</h2>
      <div id="status">Conectando...</div>
      <table id="alerts">
        <thead><tr><th>Timestamp</th><th>Sensor</th><th>Tipo</th><th>Severidad</th><th>Mensaje</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card metrics">
      <h3 style="margin-top:0">Métricas</h3>
      <pre id="metricsPre">Cargando métricas...</pre>
    </div>
  </div>
  <div class="card" style="margin-top: 16px;">
    <h2 style="margin-top:0">Rendimiento del Sistema en Tiempo Real</h2>
    <div id="chartStatus" style="color: var(--muted); font-size: 14px; margin-bottom: 10px;">
      Esperando datos del sistema...
    </div>
    <canvas id="performanceChart" width="400" height="200"></canvas>
  </div>
</section>

<section id="tab-events" class="tab">
  <div class="card">
    <h2 style="margin-top:0">Eventos</h2>
    <div class="controls">
      <label>Tipo:</label>
      <select id="typeFilter"><option value="">Todos</option><option>MOTION</option><option>TEMPERATURE</option><option>ACCESS</option></select>
      <label>Severidad:</label>
      <select id="sevFilter"><option value="">Todas</option><option>INFO</option><option>WARN</option><option>CRITICAL</option></select>
      <button id="btnLoadEvents">Cargar</button>
    </div>
    <div class="card" style="margin-bottom:12px; background:#0e1530">
      <div class="controls" style="flex-wrap:wrap">
        <strong style="margin-right:8px">Agregar evento</strong>
        <label>Sensor</label>
        <select id="sensorSelect" style="min-width:220px"></select>
        <label>Tipo</label>
        <select id="eventType">
          <option>MOTION</option>
          <option>TEMPERATURE</option>
          <option>ACCESS</option>
        </select>
        <label>Valor</label>
        <input id="eventValue" placeholder="p.ej. MOTION_DETECTED / 42 / true" value="test" style="width:240px; background:#0f1a36; color:#e6edf7; border:1px solid #233056; padding:8px 10px; border-radius:8px" />
        <label>Severidad</label>
        <select id="eventSeverity" style="min-width:120px">
          <option value="INFO">INFO</option>
          <option value="WARN">WARN</option>
          <option value="CRITICAL">CRITICAL</option>
        </select>
        <button id="btnAddEvent">Enviar</button>
      </div>
    </div>
    <table id="eventsTable">
      <thead><tr><th>Ts</th><th>SensorId</th><th>Tipo</th><th>Severidad</th><th>Valor</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<section id="tab-access" class="tab">
  <div class="card">
    <h2 style="margin-top:0">Accesos</h2>
    <table id="accessTable">
      <thead><tr><th>Ts</th><th>Persona</th><th>Autorizado</th><th>Ubicación</th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:10px"><button id="btnLoadAccess">Cargar accesos</button></div>
  </div>
</section>

<script>
  let client;
  function connect() {
    console.log('Intentando conectar WebSocket...');
    const socket = new SockJS('/ws');
    client = Stomp.over(socket);
    client.debug = function(str) {
      console.log('STOMP: ' + str);
    };
    client.connect({}, function() {
      console.log('WebSocket conectado exitosamente');
      document.getElementById('status').innerText = 'Conectado a /topic/alerts';
      client.subscribe('/topic/alerts', function(message) {
        console.log('Alerta recibida:', message.body);
        const m = JSON.parse(message.body);
        addRow(m);
      });
    }, function(error) {
      console.error('Error conectando WebSocket:', error);
      document.getElementById('status').innerText = 'Error de conexión - Reconectando...';
      setTimeout(connect, 2000);
    });
  }
  function addRow(m) {
    const tr = document.createElement('tr');
    tr.className = m.severity;
    tr.innerHTML = `<td>${new Date(m.timestamp).toLocaleTimeString()}</td><td>${m.sensorName}</td><td>${m.type}</td><td>${m.severity}</td><td>${m.message}</td>`;
    document.querySelector('#alerts tbody').prepend(tr);
  }
  async function loadMetrics() {
    try {
      const res = await fetch('/api/metrics/public');
      const data = await res.json();
      document.getElementById('metricsPre').innerText = JSON.stringify(data, null, 2);
    } catch (e) { document.getElementById('metricsPre').innerText = 'Error cargando métricas'; }
    setTimeout(loadMetrics, 5000);
  }
  async function loadEvents() {
    try {
      const type = document.getElementById('typeFilter').value;
      const sev = document.getElementById('sevFilter').value;
      const p = new URLSearchParams();
      if (type) p.append('type', type);
      if (sev) p.append('severity', sev);
      p.append('page','0'); p.append('size','20');
      const res = await fetch('/api/events?' + p.toString(), { redirect: 'manual', credentials: 'same-origin' });
      if (res.status === 401 || res.status === 403 || res.status === 302) { return showLogin(loadEvents); }
      if (!res.ok) { 
        const errorText = await res.text();
        alert('Error cargando eventos (HTTP '+res.status+'): ' + errorText); 
        return; 
      }
      const data = await res.json();
      console.log('Events data:', data);
      const tbody = document.querySelector('#eventsTable tbody');
      tbody.innerHTML = '';
      const events = data.content || [];
      events.forEach(e => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(e.ts).toLocaleString()}</td><td>${e.sensorId}</td><td>${e.type}</td><td>${e.severity}</td><td>${e.value ?? ''}</td>`;
        tbody.appendChild(tr);
      });
    } catch (error) {
      console.error('Error loading events:', error);
      alert('Error cargando eventos: ' + error.message);
    }
  }
  async function loadAccess() {
    try {
      const res = await fetch('/api/access/logs', { redirect: 'manual', credentials: 'same-origin' });
      if (res.status === 401 || res.status === 403 || res.status === 302) { return showLogin(loadAccess); }
      if (!res.ok) { 
        const errorText = await res.text();
        alert('Error cargando accesos (HTTP '+res.status+'): ' + errorText); 
        return; 
      }
      const data = await res.json();
      console.log('Access data:', data);
      const tbody = document.querySelector('#accessTable tbody');
      tbody.innerHTML = '';
      data.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(a.ts).toLocaleString()}</td><td>${a.personName} (${a.personId})</td><td>${a.authorized}</td><td>${a.location}</td>`;
        tbody.appendChild(tr);
      });
    } catch (error) {
      console.error('Error loading access:', error);
      alert('Error cargando accesos: ' + error.message);
    }
  }

  // Tabs
  function activateTab(id) {
    document.querySelectorAll('.tab').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => activateTab(btn.dataset.tab));
  });

  // Gráfico de rendimiento en tiempo real
  let performanceChart;
  let performanceData = {
    labels: [],
    datasets: [{
      label: 'Eventos/seg',
      data: [],
      borderColor: '#13b3ff',
      backgroundColor: 'rgba(19, 179, 255, 0.1)',
      tension: 0.4
    }, {
      label: 'Latencia (ms)',
      data: [],
      borderColor: '#ffbf47',
      backgroundColor: 'rgba(255, 191, 71, 0.1)',
      tension: 0.4,
      yAxisID: 'y1'
    }]
  };

  function initPerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    // Configurar Chart.js para tema oscuro
    Chart.defaults.color = '#e6edf7';
    Chart.defaults.borderColor = '#233056';
    Chart.defaults.backgroundColor = 'rgba(19, 179, 255, 0.1)';
    
    performanceChart = new Chart(ctx, {
      type: 'line',
      data: performanceData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        scales: {
          x: {
            ticks: {
              color: '#a8b3cf',
              maxTicksLimit: 10
            },
            grid: {
              color: '#233056'
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'Eventos/seg',
              color: '#e6edf7'
            },
            ticks: {
              color: '#a8b3cf'
            },
            grid: {
              color: '#233056'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'Latencia (ms)',
              color: '#e6edf7'
            },
            ticks: {
              color: '#a8b3cf'
            },
            grid: {
              drawOnChartArea: false,
            },
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: '#e6edf7'
            }
          },
          tooltip: {
            backgroundColor: '#111931',
            titleColor: '#e6edf7',
            bodyColor: '#a8b3cf',
            borderColor: '#233056',
            borderWidth: 1
          }
        }
      }
    });
  }

  async function updatePerformanceChart() {
    try {
      // Obtener métricas específicas de sensores
      const res = await fetch('/api/sensors/metrics');
      if (res.ok) {
        const metrics = await res.json();
        console.log('Métricas obtenidas:', metrics);
        
        // Extraer métricas relevantes
        const eventsProcessed = metrics.sensor_events_processed_total || 0;
        const latency = metrics.sensor_events_latency_ms || 0;
        
        // Solo agregar datos si hay métricas reales
        if (eventsProcessed > 0 || latency > 0) {
          const now = new Date();
          const time = now.toLocaleTimeString();
          
          // Agregar nuevos datos
          performanceData.labels.push(time);
          performanceData.datasets[0].data.push(eventsProcessed);
          performanceData.datasets[1].data.push(latency);
          
          // Mantener solo los últimos 20 puntos
          if (performanceData.labels.length > 20) {
            performanceData.labels.shift();
            performanceData.datasets[0].data.shift();
            performanceData.datasets[1].data.shift();
          }
          
          // Actualizar gráfico
          if (performanceChart) {
            performanceChart.update('none');
          }
          
          // Actualizar estado
          document.getElementById('chartStatus').textContent = 
            `Datos en tiempo real - Eventos procesados: ${eventsProcessed}, Latencia promedio: ${latency.toFixed(1)}ms`;
        } else {
          // No hay datos reales disponibles
          document.getElementById('chartStatus').textContent = 
            'Esperando actividad del sistema... (Procesa algunos eventos para ver datos)';
        }
      }
    } catch (error) {
      console.log('Error obteniendo métricas para gráfico:', error);
      document.getElementById('chartStatus').textContent = 
        'Error obteniendo métricas del sistema';
    }
  }

  // Init
  connect();
  loadMetrics();
  initPerformanceChart();
  
  // Actualizar gráfico cada 2 segundos
  setInterval(updatePerformanceChart, 2000);
  
  // Test simple para verificar que JavaScript funciona
  console.log('JavaScript is working!');
  
  // Debug: Verificar que los elementos existen
  console.log('btnLoadEvents element:', document.getElementById('btnLoadEvents'));
  console.log('btnLoadAccess element:', document.getElementById('btnLoadAccess'));
  
  // Test de función
  window.testLoadEvents = function() {
    console.log('testLoadEvents called');
    loadEvents();
  };
  
  // Event listeners con debugging
  const btnLoadEvents = document.getElementById('btnLoadEvents');
  const btnLoadAccess = document.getElementById('btnLoadAccess');
  
  if (btnLoadEvents) {
    btnLoadEvents.addEventListener('click', function() {
      console.log('btnLoadEvents clicked');
      loadEvents();
    });
  } else {
    console.error('btnLoadEvents not found!');
  }
  
  if (btnLoadAccess) {
    btnLoadAccess.addEventListener('click', function() {
      console.log('btnLoadAccess clicked');
      loadAccess();
    });
  } else {
    console.error('btnLoadAccess not found!');
  }
  // Cargar sensores para el combo de "Agregar evento"
  async function loadSensors() {
    try {
      const res = await fetch('/api/sensors/public', { credentials: 'same-origin', redirect: 'manual' });
      if (res.status === 401 || res.status === 302) return; // se pedirá login al intentar enviar
      const sensors = await res.json();
      const sel = document.getElementById('sensorSelect');
      sel.innerHTML = '';
      sensors.forEach(s => {
        const o = document.createElement('option'); o.value = s.id; o.textContent = `${s.name} (${s.type})`;
        sel.appendChild(o);
      });
    } catch (e) {
      console.error('Error loading sensors:', e);
    }
  }
  loadSensors();

  async function addEvent() {
    const sensorId = document.getElementById('sensorSelect').value;
    const type = document.getElementById('eventType').value;
    const value = document.getElementById('eventValue').value || '';
    const severity = document.getElementById('eventSeverity').value;
    if (!sensorId) { alert('Selecciona un sensor'); return; }
    const body = JSON.stringify({ sensorId, type, value, severity });
    const res = await fetch(`/api/sensors/${sensorId}/events`, { method: 'POST', headers: { 'Content-Type':'application/json' }, body, credentials: 'same-origin', redirect: 'manual' });
    if (res.status === 401 || res.status === 302) { return showLogin(addEvent); }
    if (res.status === 403) { alert('No autorizado para enviar eventos'); return; }
    if (res.ok || res.status === 202) {
      document.getElementById('eventValue').value = '';
      // refrescar tabla de eventos
      setTimeout(loadEvents, 300);
    } else {
      alert('Error enviando evento (HTTP '+res.status+')');
    }
  }
  document.getElementById('btnAddEvent').addEventListener('click', addEvent);

  // Login modal logic
  let pendingAction = null;
  function showLogin(next) {
    pendingAction = next;
    document.getElementById('loginOverlay').classList.add('show');
  }
  async function doLogin(ev) {
    ev.preventDefault();
    const form = ev.target;
    const u = form.username.value; const p = form.password.value;
    const body = new URLSearchParams({ username: u, password: p }).toString();
    const res = await fetch('/login', { method: 'POST', headers: {'Content-Type':'application/x-www-form-urlencoded'}, body, redirect: 'manual', credentials: 'same-origin' });
    if (res.ok || res.status === 302) {
      document.getElementById('loginErr').style.display = 'none';
      document.getElementById('loginOverlay').classList.remove('show');
      // Verificar que la sesión está activa antes de reintentar
      try {
        const probe = await fetch('/api/sensors', { credentials: 'same-origin', redirect: 'manual' });
        if (probe.status === 401 || probe.status === 403) {
          document.getElementById('loginErr').style.display = 'block';
          return;
        }
      } catch {}
      const next = pendingAction; pendingAction = null; if (next) next();
    } else {
      document.getElementById('loginErr').style.display = 'block';
    }
  }
  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('loginForm').addEventListener('submit', doLogin);
    document.getElementById('loginCancel').addEventListener('click', () => {
      pendingAction = null; document.getElementById('loginOverlay').classList.remove('show');
    });
    
    // Re-attach event listeners after DOM is loaded
    const btnLoadEvents = document.getElementById('btnLoadEvents');
    const btnLoadAccess = document.getElementById('btnLoadAccess');
    
    if (btnLoadEvents) {
      btnLoadEvents.addEventListener('click', function() {
        console.log('btnLoadEvents clicked (DOMContentLoaded)');
        loadEvents();
      });
    }
    
    if (btnLoadAccess) {
      btnLoadAccess.addEventListener('click', function() {
        console.log('btnLoadAccess clicked (DOMContentLoaded)');
        loadAccess();
      });
    }
  });
</script>

<!-- Login Overlay -->
<div class="overlay" id="loginOverlay">
  <form class="card login-card" id="loginForm">
    <h3>Autenticación requerida</h3>
    <label>Usuario</label>
    <input type="text" name="username" required autocomplete="username" />
    <label>Contraseña</label>
    <input type="password" name="password" required autocomplete="current-password" />
    <div style="display:flex; gap:8px; margin-top:12px">
      <button type="submit" style="flex:1">Entrar</button>
      <button type="button" id="loginCancel" style="flex:1">Cancelar</button>
    </div>
    <div class="err" id="loginErr">Credenciales inválidas</div>
    <p style="color:#a8b3cf; margin-top:10px">Demo: admin/admin, sec/sec, op/op, view/view</p>
  </form>
</div>
 </main>
 </body>
 </html>



